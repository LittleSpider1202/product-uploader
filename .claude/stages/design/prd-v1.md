# 淘宝商品一键上架工具 PRD v1

---

## 概览

### 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v1.4 |
| 状态 | 进行中 |
| 更新日期 | 2026-01-30 |

### 目录结构

| # | 章节 | 概要 |
|---|------|------|
| 1 | 背景与目标 | 手动上架效率低，目标单品 <5 分钟、成功率 >99% |
| 2 | 用户画像与场景 | MVP 优先新手卖家，单店单品复制场景 |
| 3 | 功能范围 | 做：采集+预览+上架；不做：批量、图片处理、多平台 |
| 4 | 系统解构 | 问题解决机制设计：执行→识别→归类→匹配→沉淀 |
| 5 | 评价体系 | 总体/类目/商品三维度，进化指标跟踪 |
| 6 | 优化回路 | 问题录入、分类体系、codegen 录制沉淀 |
| 7 | 交互设计 | **学习驱动初始化** + **交互引导为主** + CLI 浏览器联动 |
| 8 | 数据设计 | 商品包、配置、记录、知识库实体 |
| 9 | 异常与兜底 | 重试、暂停、人工介入策略 |
| 10 | 开放问题 | 登录态、存储格式等（研发阶段解决） |

### 快速导航

- **核心设计理念**：见第 4 节（问题解决机制）
- **学习驱动初始化**：见第 7.1 节
- **命令结构与交互流程**：见第 7.2-7.4 节
- **Codegen 交互**：见第 6.4 节
- **开放问题**：见第 10 节

---

## 1. 背景与目标

### 背景

天猫/淘宝卖家在上架商品时面临效率瓶颈：
- 手动上架单品需 30-60 分钟
- 日均 50+ 商品的卖家无法完成
- 现有工具（甩手、大淘营等）功能复杂、付费门槛高

### 产品目标

| 目标层级 | 目标 | 量化指标 |
|----------|------|----------|
| 用户目标 | 提升上架效率 | 单品 < 5 分钟 |
| 用户目标 | 保证可靠性 | 成功率 > 99% |
| 业务目标 | 验证 PMF | 用户愿意付费 |

---

## 2. 用户画像与场景

### MVP 优先用户

**新手卖家** — 单店、单品复制场景

| 特征 | 说明 |
|------|------|
| 刚开店 | 想参考爆款快速起步 |
| 核心诉求 | 低门槛复制成功商品 |
| 场景 | 看到爆款 → 复制到自己店铺 |

### 后续扩展用户

- 货源商/分销商 — 多店铺货（需账号切换）
- 代运营公司 — 批量处理（复杂度高）

---

## 3. 功能范围（做/不做）

### MVP 约束条件

| 约束 | 说明 |
|------|------|
| 商品来源 | 淘宝/天猫商品（复制竞品/爆款） |
| 目标店铺 | 天猫店 + 淘宝 C 店 |
| 类目 | 食品类目（有自有店铺可测试） |
| 操作模式 | 单品（非批量） |

### MVP 功能

| 功能 | 说明 |
|------|------|
| 商品采集 | 从淘宝/天猫链接提取商品信息 |
| 默认配置 | 预设不可采集字段的默认值 |
| 本地预览/编辑 | 查看并修改商品信息 |
| 一键上架 | 自动提交到目标店铺 |

### MVP 不做

| 功能 | 原因 |
|------|------|
| 批量采集 | MVP 先验证单品流程 |
| 多店铺同时上架 | MVP 先单店 |
| 图片处理（去水印等） | 增加复杂度 |
| 自动改价/改标题 | 非核心需求 |
| 1688 货源采集 | 后续迭代 |

---

## 4. 系统解构

> **核心理念**：设计的是问题解决机制，而非功能模块。目标是让系统在持续使用中自我进化。

### 4.1 核心机制

| 机制 | 职责 |
|------|------|
| **执行机制** | 完成采集 → 填充 → 上传流程 |
| **问题识别** | 检测执行过程中的异常 |
| **问题归类** | 按阶段/类目/字段/原因分类 |
| **方案匹配** | 已知问题自动解决，未知问题人工介入 |
| **知识沉淀** | 人工解决方案 → 沉淀为规则 |

### 4.2 知识库设计

```
知识库
├── 问题库（遇到过的问题）
│   ├── 问题特征（如何识别）
│   ├── 发生频率
│   └── 关联类目/字段
│
├── 解决方案库
│   ├── 自动方案（规则/脚本）
│   └── 人工方案（操作指引）
│
├── 字段规则库（学习驱动）
│   ├── 固定字段（学习识别）
│   ├── 动态字段（学习识别 + 类目关联）
│   └── 可选字段（学习识别）
│
└── 交互模式库
    └── 复杂交互的操作步骤（codegen 录制）
```

### 4.3 核心流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 配置阶段（一次性）                                    │
│    └── 设置默认配置：运费模板、发货地、素材目录等        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 采集阶段                                              │
│    ├── 输入源商品链接                                    │
│    ├── 系统自动采集商品信息                              │
│    └── 输出：商品数据包                                  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 预览/编辑阶段                                         │
│    ├── 展示采集结果 + 默认配置                           │
│    ├── 用户修改（标题、价格、素材目录等）                │
│    └── 确认上架                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 4. 上架阶段                                              │
│    ├── 上传图片到指定素材目录                            │
│    ├── 填充通用必填字段                                  │
│    ├── 动态识别类目字段，填充必填项                      │
│    ├── 遇到复杂交互 → 暂停，用户手动                     │
│    └── 完成上架                                          │
└─────────────────────────────────────────────────────────┘
```

### 4.4 关键设计决策

#### 字段分类与处理

> **学习驱动**：不预设字段规则，通过学习期观察用户操作自动识别

| 字段分类 | 判断方式 | 处理策略 | 示例 |
|----------|----------|----------|------|
| **固定字段** | 学习期每次都填 | 自动采集/填充 | 标题、价格、主图、SKU |
| **动态字段** | 学习期部分出现 | 按类目判断是否填充 | 保质期、尺寸、材质 |
| **可选字段** | 学习期偶尔填写 | 非必填，跳过 | 产地、备注 |

#### 表单填充原则

| 原则 | 说明 |
|------|------|
| **最小化输入** | 非必填不填，必填无法采集则手动 |
| **采集优先** | 能采集的自动填充，用户可修改 |
| **配置兜底** | 不可采集的必填项，使用默认配置 |

#### 复杂交互处理

| 交互类型 | 处理方式 |
|----------|----------|
| 文本/数字输入 | 自动填充 |
| 简单下拉 | 自动匹配选项 |
| 图片上传 | 自动上传 |
| **关联选择/新建** | **暂停，用户手动** |
| **复杂弹窗** | **暂停，用户手动** |

#### 素材上传

| 决策 | 说明 |
|------|------|
| 上传方式 | 本地上传（采集后直接上传） |
| 目录管理 | 用户预建目录结构 |
| 目录指定 | 按商品配置，可覆盖默认 |

---

## 5. 评价体系

### 5.1 目标拆解

```
总目标：上架成功率 > 99%，单品 < 5 分钟
                    │
    ┌───────────────┼───────────────┐
    ↓               ↓               ↓
  采集成功率      填充成功率      上传成功率
   > 99.5%        > 99.5%         > 99.5%
    │               │               │
    ↓               ↓               ↓
  采集耗时        填充耗时        上传耗时
   < 1 分钟       < 2 分钟        < 2 分钟
```

### 5.2 衡量维度

**总体维度**

| 指标 | 目标 | 计算方式 |
|------|------|----------|
| 上架成功率 | > 99% | 成功数 / 总数 |
| 单品耗时 | < 5 分钟 | 从开始到完成 |

**类目维度**

| 指标 | 说明 | 用途 |
|------|------|------|
| 类目成功率 | 该类目下的上架成功率 | 发现问题类目 |
| 类目平均耗时 | 该类目下的平均上架时间 | 识别复杂类目 |
| 类目问题分布 | 该类目下的问题类型占比 | 针对性优化 |

**商品维度**

| 指标 | 说明 | 用途 |
|------|------|------|
| 商品上架状态 | 成功 / 失败 / 人工介入 | 追踪单品结果 |
| 商品耗时 | 该商品上架总耗时 | 定位慢商品 |
| 商品问题记录 | 该商品遇到的具体问题 | 问题归因 |

### 5.3 进化指标

| 指标 | 说明 | 期望趋势 |
|------|------|----------|
| 知识库规模 | 问题 + 方案数量 | ↑ 增长 |
| 人工介入频率 | 每 N 单需人工一次 | ↓ 降低 |
| 新问题比例 | 未知问题 / 总问题 | ↓ 降低 |

---

## 6. 优化回路

### 6.1 问题回收机制

**问题采集点**

| 阶段 | 采集点 | 采集内容 |
|------|--------|----------|
| 采集 | 页面加载 | 超时、加载失败、反爬拦截 |
| 采集 | 数据提取 | 字段缺失、格式异常 |
| 填充 | 字段识别 | 必填判断错误、字段定位失败 |
| 填充 | 数据填入 | 填充失败、格式校验不通过 |
| 填充 | 复杂交互 | 弹窗、关联选择等暂停点 |
| 上传 | 素材上传 | 图片格式、大小、上传失败 |
| 上传 | 表单提交 | 提交失败、审核不通过 |

**问题记录结构**

```
问题记录：
├── 基础信息
│   ├── 时间
│   ├── 商品ID（源）
│   └── 类目
│
├── 问题描述
│   ├── 阶段（采集/填充/上传）
│   ├── 具体步骤
│   ├── 错误信息
│   └── 截图/上下文
│
└── 处理结果
    ├── 解决方式（自动/人工）
    └── 解决方案（如有）
```

### 6.2 问题归因网络

```
问题归因
├── 按阶段
│   ├── 采集阶段 → 页面结构?反爬?网络?
│   ├── 填充阶段 → 字段规则?表单变化?数据问题?
│   └── 上传阶段 → 素材问题?平台规则?
│
├── 按类目
│   └── 特定类目问题 → 类目特有字段?规则差异?
│
└── 按原因类型
    ├── 平台变化（页面/规则更新）
    ├── 数据问题（源商品数据异常）
    ├── 配置缺失（默认配置未设置）
    └── 未知问题（待分析）
```

### 6.3 闭环修复路径

**解决方案类型**

| 类型 | 说明 | 示例 |
|------|------|------|
| **自动重试** | 临时性问题 | 网络超时 → 重试 |
| **规则更新** | 字段规则变化 | 新增必填字段 → 更新字段库 |
| **配置补充** | 缺少默认值 | 运费模板未配 → 提示配置 |
| **人工介入** | 复杂交互 | 规格关联 → 暂停让用户处理 |
| **方案沉淀** | 新问题解决后 | 记录解决步骤 → 下次自动 |

**问题解决闭环**

```
    上架执行 ──→ 遇到问题 ──→ 问题记录 ──→ 问题归类
        ↑                                    ↓
        │                              解决方案匹配
        │                                    ↓
        │         ┌──────────────────────────┴────────┐
        │         ↓                                   ↓
        │    已知问题                             未知问题
        │    (自动解决)                          (人工介入)
        │         ↓                                   ↓
        │    应用方案                             人工解决
        │         ↓                                   ↓
        └──── 继续执行 ←───────────────────── 方案沉淀
                                                     ↓
                                              知识库更新
```

### 6.4 优化回路交互流程

#### 问题录入流程

**自动采集的信息（系统自动记录）**

```
问题自动采集：
├── 基础信息
│   ├── 问题编号（自动生成）
│   ├── 发生时间
│   ├── 源商品链接
│   └── 目标店铺
│
├── 上下文信息
│   ├── 当前阶段（采集/填充/上传）
│   ├── 当前步骤（如：填充第3个字段）
│   ├── 目标字段名称
│   ├── 页面 URL
│   ├── 页面截图（自动保存）
│   └── 相关 DOM 元素信息
│
├── 错误信息
│   ├── 错误类型（超时/元素未找到/校验失败/...）
│   ├── 错误消息
│   └── 堆栈信息（技术日志）
│
└── 商品上下文
    ├── 商品类目
    ├── 当前填充的数据
    └── 已完成的步骤
```

**用户补充的信息（人工介入时）**

```
$ ecom upload ./products/xxx.json

❌ 检测到问题：元素定位失败
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   问题编号: #P043
   阶段: 填充
   步骤: 填充字段 [生产许可证]
   错误: 找不到输入框元素
   截图: ./logs/screenshots/P043.png
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

? 请选择问题分类:
  (1) 页面结构变化 - 淘宝页面改版导致
  (2) 动态加载 - 元素需要等待或触发
  (3) 弹窗/浮层 - 字段在弹窗中
  (4) 数据问题 - 填充的数据格式不对
  (5) 权限/登录 - 登录态失效或无权限
  (6) 其他
> 3

? 请选择具体原因:
  (1) 需要点击展开按钮
  (2) 需要滚动页面加载
  (3) 在二级弹窗中
  (4) 自定义描述
> 1

? 补充说明（可选，直接回车跳过）: 点击"查看更多"后出现

✓ 问题信息已完善

? 请选择处理方式:
  (1) 在浏览器手动处理
  (2) 跳过此字段
  (3) 终止上架
> 1
```

**问题分类体系**

| 一级分类 | 二级分类 | 说明 |
|----------|----------|------|
| **页面结构变化** | 元素选择器失效 | 淘宝改版导致 |
| | 页面布局变化 | 字段位置移动 |
| | 新增必填字段 | 平台新增要求 |
| **动态加载** | 异步加载 | 元素需等待 |
| | 懒加载 | 需滚动触发 |
| | 条件渲染 | 依赖其他字段 |
| **弹窗/浮层** | 一级弹窗 | 点击后弹出 |
| | 二级弹窗 | 弹窗中的弹窗 |
| | 下拉面板 | 展开式面板 |
| **数据问题** | 格式不匹配 | 数据格式错误 |
| | 长度超限 | 超出字数限制 |
| | 非法字符 | 包含违禁词 |
| **权限/登录** | 登录态失效 | 需重新登录 |
| | 无操作权限 | 店铺权限不足 |
| **网络问题** | 超时 | 请求超时 |
| | 连接失败 | 网络中断 |
| **其他** | 未知错误 | 待分析 |

**问题记录完整结构**

```
问题 #P043
├── 基础信息
│   ├── 编号: P043
│   ├── 时间: 2026-01-29 15:30:22
│   ├── 源商品: https://item.taobao.com/item.htm?id=xxx
│   └── 目标店铺: 我的有机杂粮店
│
├── 上下文
│   ├── 阶段: 填充
│   ├── 步骤: 填充字段 [生产许可证]
│   ├── 类目: 食品 > 粮油米面
│   ├── 页面URL: https://upload.taobao.com/...
│   └── 截图: ./logs/screenshots/P043.png
│
├── 问题分类
│   ├── 一级: 弹窗/浮层
│   ├── 二级: 一级弹窗
│   └── 原因: 需要点击展开按钮
│
├── 错误详情
│   ├── 类型: 元素定位失败
│   ├── 消息: 找不到输入框元素
│   └── 选择器: #license-input
│
├── 用户补充
│   └── 说明: 点击"查看更多"后出现
│
└── 处理结果
    ├── 方式: 人工处理
    ├── 是否沉淀: 是
    └── 沉淀方案: 先点击.expand-more-btn，等待500ms后定位
```

#### 问题发生时的交互

**场景 1：已知问题（自动解决）**

```
$ ecom upload ./products/xxx.json

⏳ 正在填充表单...
⚠️ 检测到问题：字段定位失败 [品牌]
🔍 匹配到已知问题 #P001
🔄 正在应用解决方案：使用备选选择器
✓ 问题已自动解决，继续执行...
```

**场景 2：未知问题（人工介入）**

```
$ ecom upload ./products/xxx.json

⏳ 正在填充表单...
❌ 检测到问题：未知错误
   阶段：填充
   字段：生产许可证
   错误：找不到输入框

? 请选择处理方式:
  (1) 在浏览器手动处理，完成后按 Enter
  (2) 跳过此字段
  (3) 终止上架
  (4) 查看问题详情
> 1

⏸️ 请在浏览器中手动完成，完成后按 Enter...
[用户在浏览器操作]

✓ 已继续执行

? 是否将此解决方式沉淀到知识库？(Y/n) y
? 请简要描述解决方法: 该字段在弹窗中，需点击"更多信息"展开
✓ 已记录到知识库，问题编号 #P042
```

#### 问题沉淀交互

**人工解决后的沉淀流程**

```
问题解决 → 询问是否沉淀？
              ↓
        ┌─── 是 ───→ 输入解决方法描述
        │              ↓
        │         保存到知识库
        │              ↓
        │         输出问题编号
        │
        └─── 否 ───→ 仅记录问题日志（不沉淀方案）
```

#### 知识库管理交互

**查看问题历史**

```
$ ecom problems

最近问题记录：
┌──────┬────────┬──────────┬──────────┬──────────┐
│ 编号 │ 阶段   │ 字段     │ 解决方式 │ 时间     │
├──────┼────────┼──────────┼──────────┼──────────┤
│ #042 │ 填充   │ 生产许可证│ 人工沉淀 │ 10分钟前 │
│ #041 │ 采集   │ SKU      │ 自动重试 │ 1小时前  │
│ #040 │ 上传   │ 主图     │ 人工跳过 │ 2小时前  │
└──────┴────────┴──────────┴──────────┴──────────┘

输入编号查看详情，或按 Enter 返回
```

**查看知识库**

```
$ ecom knowledge

知识库统计：
├── 问题总数：42
├── 已沉淀方案：28
└── 自动解决率：66.7%

按类型分布：
├── 采集阶段：12 (自动解决 10)
├── 填充阶段：25 (自动解决 15)
└── 上传阶段：5  (自动解决 3)

命令：
  ecom knowledge list    列出所有已沉淀方案
  ecom knowledge search  搜索问题/方案
  ecom knowledge export  导出知识库
```

**编辑知识库方案**

```
$ ecom knowledge edit #P042

问题 #P042：
├── 阶段：填充
├── 字段：生产许可证
├── 错误：找不到输入框
└── 当前方案：该字段在弹窗中，需点击"更多信息"展开

? 选择操作:
  (1) 修改方案描述
  (2) 标记为自动化（添加选择器规则）
  (3) 删除此方案
  (4) 返回
> 2

? 请输入备选选择器: .expand-btn + .license-input
✓ 已更新，下次遇到将自动处理
```

#### 问题分类管理

**查看分类体系**

```
$ ecom category list

问题分类体系：
├── 页面结构变化 (12个问题)
│   ├── 元素选择器失效 (8)
│   ├── 页面布局变化 (3)
│   └── 新增必填字段 (1)
│
├── 动态加载 (8个问题)
│   ├── 异步加载 (5)
│   ├── 懒加载 (2)
│   └── 条件渲染 (1)
│
├── 弹窗/浮层 (15个问题)
│   ├── 一级弹窗 (10)
│   ├── 二级弹窗 (3)
│   └── 下拉面板 (2)
│
├── 数据问题 (5个问题)
│   ├── 格式不匹配 (2)
│   ├── 长度超限 (2)
│   └── 非法字符 (1)
│
├── 权限/登录 (2个问题)
│   ├── 登录态失效 (2)
│   └── 无操作权限 (0)
│
└── [自定义] 类目特有 (3个问题)  ← 用户新增的分类
    ├── 食品-许可证字段 (2)
    └── 食品-保质期格式 (1)

命令：
  ecom category add     新增分类
  ecom category edit    修改分类
  ecom category delete  删除分类
```

**新增分类**

```
$ ecom category add

? 选择父分类:
  (1) 页面结构变化
  (2) 动态加载
  (3) 弹窗/浮层
  (4) 数据问题
  (5) 权限/登录
  (6) 网络问题
  (7) 其他
  (8) [新建一级分类]
> 8

? 输入一级分类名称: 类目特有
? 输入分类描述（可选）: 特定类目才会遇到的问题
✓ 已创建一级分类：类目特有

? 是否立即添加二级分类？(Y/n) y
? 输入二级分类名称: 食品-许可证字段
? 输入分类描述（可选）: 食品类目的生产许可证相关问题
✓ 已创建二级分类：类目特有 > 食品-许可证字段

? 继续添加二级分类？(Y/n) y
? 输入二级分类名称: 食品-保质期格式
✓ 已创建二级分类：类目特有 > 食品-保质期格式

? 继续添加二级分类？(Y/n) n
✓ 分类创建完成
```

**修改分类**

```
$ ecom category edit

? 选择要修改的分类:
  (1) 页面结构变化
  (2) 动态加载
  ...
  (8) 类目特有
> 8

? 选择操作:
  (1) 修改分类名称
  (2) 修改分类描述
  (3) 添加二级分类
  (4) 管理二级分类
  (5) 返回
> 1

? 输入新名称: 类目特有问题
✓ 已更新分类名称
```

**删除分类**

```
$ ecom category delete

? 选择要删除的分类:
  (1) 类目特有问题 (3个问题)
> 1

⚠️ 该分类下有 3 个问题记录
? 如何处理这些问题？
  (1) 移动到其他分类
  (2) 移动到"其他"分类
  (3) 取消删除
> 1

? 选择目标分类: 数据问题
✓ 已将 3 个问题移动到"数据问题"
✓ 已删除分类"类目特有问题"
```

**重新分类已有问题**

```
$ ecom problem reclassify #P043

问题 #P043 当前分类：
├── 一级: 弹窗/浮层
└── 二级: 一级弹窗

? 选择新的一级分类:
  (1) 页面结构变化
  (2) 动态加载
  (3) 弹窗/浮层 (当前)
  (4) 数据问题
  (5) 类目特有问题
  ...
> 5

? 选择二级分类:
  (1) 食品-许可证字段
  (2) 食品-保质期格式
  (3) [新建二级分类]
> 1

✓ 问题 #P043 已重新分类为：类目特有问题 > 食品-许可证字段
```

**分类配置导入/导出**

```
$ ecom category export

✓ 分类配置已导出到 ./config/categories.json

$ ecom category import ./config/categories-v2.json

? 发现 2 个新分类，5 个修改，确认导入？(Y/n) y
✓ 分类配置已更新
```

#### Codegen 录制交互

> **核心理念**：将人工操作录制为可复用的自动化方案，让系统在使用中自我进化

**设计决策**

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 沉淀格式 | 结构化步骤 | 解析为操作序列（click/fill/wait），存储为 JSON |
| 集成方式 | 分级处理 | 新方案需确认，经 N 次验证后自动执行 |

**结构化方案格式**

```json
{
  "id": "S043",
  "name": "生产许可证-展开弹窗填写",
  "trigger": {
    "page": "product-publish",
    "category": "食品/*",
    "field": "生产许可证",
    "error": "element_not_found"
  },
  "steps": [
    {"action": "click", "selector": ".more-info-btn", "description": "点击更多信息"},
    {"action": "wait", "duration": 500},
    {"action": "fill", "selector": "#license-input", "value": "${field_value}"}
  ],
  "verification": {
    "success": {"selector": "#license-input", "hasValue": true}
  },
  "stats": {
    "created": "2026-01-30T10:30:00Z",
    "executions": 0,
    "successes": 0,
    "trustLevel": "new"
  }
}
```

**信任等级机制**

| 等级 | 条件 | 执行方式 |
|------|------|----------|
| `new` | 刚录制 | 每次询问确认 |
| `testing` | 执行 1-2 次成功 | 默认执行，可跳过 |
| `trusted` | 连续 3+ 次成功 | 自动执行 |
| `failed` | 最近失败 | 每次询问确认，提示重新录制 |

**场景 1：问题解决时录制**

```
❌ 检测到问题：元素定位失败
   字段: [生产许可证]

? 请选择处理方式:
  (1) 在浏览器手动处理
  (2) 🎬 使用 codegen 录制操作
  (3) 跳过此字段
> 2

🎬 正在启动 codegen...
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   1. 在弹出的浏览器窗口中完成操作
   2. 操作会被自动录制
   3. 完成后关闭 codegen 窗口
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[用户在 codegen 浏览器中操作]

✓ 录制完成
   检测到 3 个操作步骤：
   ├── 1. click('.more-info-btn')
   ├── 2. wait(500ms)
   └── 3. fill('#license-input')

? 保存此方案？(Y/n) y
? 方案名称: 生产许可证-展开弹窗
✓ 方案已保存 [S043]，信任等级: new

? 立即执行此方案？(Y/n) y
⏳ 执行中...
✓ 执行成功，继续上架流程
```

**场景 2：匹配到新方案（需确认）**

```
⚠️ 检测到问题：元素定位失败
   字段: [生产许可证]
🔍 匹配到录制方案 [S043]: 生产许可证-展开弹窗
   信任等级: new (首次使用)

? 是否执行此方案？
  (1) 执行
  (2) 跳过，手动处理
  (3) 查看方案详情
> 1

⏳ 执行方案 [S043]...
✓ 执行成功 [S043 统计: 1次成功]
```

**场景 3：匹配到可信方案（自动执行）**

```
⚠️ 检测到问题：元素定位失败
   字段: [生产许可证]
🔍 匹配到可信方案 [S043]: 生产许可证-展开弹窗
🔄 自动执行中...
✓ 执行成功 [S043 统计: 5次成功]
```

**场景 4：方案执行失败**

```
⚠️ 检测到问题：元素定位失败
🔍 匹配到可信方案 [S043]
🔄 自动执行中...
❌ 方案执行失败：选择器 .more-info-btn 未找到

? 请选择处理方式:
  (1) 手动处理
  (2) 🎬 重新录制方案
  (3) 跳过
> 2

🎬 正在启动 codegen（覆盖方案 S043）...
[录制完成]
✓ 方案 [S043] 已更新，信任等级重置为 new
```

**方案管理命令**

```
$ ecom codegen list           # 列出所有录制方案
$ ecom codegen show <id>      # 查看方案详情
$ ecom codegen edit <id>      # 编辑方案
$ ecom codegen delete <id>    # 删除方案
$ ecom codegen test <id>      # 在当前页面测试方案
$ ecom codegen export         # 导出方案库
$ ecom codegen import <file>  # 导入方案库
```

**与知识库的关系**

```
问题记录 ───→ 人工解决 ───→ codegen 录制 ───→ 结构化方案
    │                                            ↓
    └───────────────────────────────────── 关联存储

知识库
├── 问题库
│   └── #P043: 生产许可证定位失败
│             └── 关联方案: S043
│
└── 方案库
    └── S043: 生产许可证-展开弹窗
              ├── 操作步骤 (JSON)
              ├── 触发条件
              └── 信任等级 + 统计
```

---

## 7. 交互设计

### 学习驱动初始化

> **核心理念**：不预设规则，通过观察用户操作来学习字段分类和交互模式

**设计决策**

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 学习次数 | 5 次 | 可提前结束或继续学习 |
| 学习方式 | 纯录制观察 | 用户正常操作，系统静默录制 |
| 结果确认 | 每次录制后确认 | 不一致时提示用户重新确认 |

**学习期流程**

```
首次使用
    ↓
"检测到新环境，需要学习您的上架习惯"
"请正常完成 5 次商品上架，系统会在后台学习"
    ↓
┌─────────────────────────────────────────┐
│ 学习期（第 1-5 次上架）                  │
│                                          │
│  用户正常操作 ←──→ 系统静默录制          │
│                                          │
│  每次完成后：                            │
│  ├── 展示识别的字段                      │
│  ├── 用户确认分类（固定/动态/可选）      │
│  └── 不一致时提示重新确认                │
└─────────────────────────────────────────┘
    ↓
学习完成，输出识别结果
    ↓
┌─────────────────────────────────────────┐
│ 自动化期（第 6 次起）                    │
│                                          │
│  系统自动执行 → 遇问题 → 人工介入        │
│                     ↓                    │
│                持续学习优化               │
└─────────────────────────────────────────┘
```

**每次录制后的确认交互**

```
✓ 第 1 次录制完成

检测到以下字段，请确认分类：
┌────────────┬──────────────┬──────────┐
│ 字段       │ 系统判断      │ 确认     │
├────────────┼──────────────┼──────────┤
│ 商品标题   │ 固定字段      │ [Y/n]    │
│ 价格       │ 固定字段      │ [Y/n]    │
│ 主图       │ 固定字段      │ [Y/n]    │
│ 保质期     │ 动态字段 ?    │ [1/2/3]  │
│ 生产许可证 │ 动态字段 ?    │ [1/2/3]  │
└────────────┴──────────────┴──────────┘

? 保质期 应该是：
  (1) 固定字段 - 每次都需要填
  (2) 动态字段 - 随类目变化
  (3) 可选字段 - 非必填
> 2

✓ 已记录，继续下一次上架
   学习进度：1/5
```

**不一致检测与处理**

| 不一致类型 | 示例 | 处理方式 |
|------------|------|----------|
| 新增字段 | 第3次出现新字段「材质」 | 询问是动态还是漏填 |
| 缺失字段 | 某次没填「产地」 | 询问是可选还是漏填 |
| 分类冲突 | 上次说固定，这次说动态 | 强制再次确认 |
| 值变化 | 运费模板每次不同 | 识别为需选择，非固定默认 |

```
⚠️ 检测到字段分类可能不一致：

字段「产地」：
├── 第1次：已填写，确认为「固定字段」
├── 第3次：未填写
└── 第5次：已填写，但值不同

? 请重新确认「产地」的分类：
  (1) 固定字段 - 每次必填，有默认值
  (2) 动态字段 - 根据类目决定是否填
  (3) 可选字段 - 非必填，想填就填
> 3

✓ 已将「产地」标记为可选字段
```

**学习完成总结**

```
✓ 已完成 5 次学习录制

识别结果：
┌─────────────────────────────────────┐
│ 固定字段（每次都填）                 │
│ ├── 商品标题                        │
│ ├── 价格                            │
│ ├── 主图                            │
│ ├── SKU                             │
│ └── 运费模板 (默认值: 包邮)         │
│                                     │
│ 动态字段（随类目变化）               │
│ ├── 保质期（食品类目）              │
│ ├── 生产许可证（食品类目）          │
│ └── 品牌（部分类目）                │
│                                     │
│ 可选字段                            │
│ └── 产地                            │
│                                     │
│ 已学习的交互模式                    │
│ ├── 生产许可证需点击展开            │
│ └── 品牌选择需搜索弹窗              │
└─────────────────────────────────────┘

? 确认以上学习结果？
  (1) 确认，开始自动化
  (2) 继续学习几次
  (3) 手动修改配置
> 1

✓ 学习完成！后续上架将自动执行
```

**学习数据结构**

```json
{
  "learningStatus": {
    "phase": "learning",
    "sessions": 5,
    "completed": 3
  },
  "fields": {
    "商品标题": {
      "occurrences": [1, 2, 3, 4, 5],
      "classification": "fixed",
      "confidence": "high",
      "confirmedBy": "user"
    },
    "保质期": {
      "occurrences": [1, 3],
      "classification": "dynamic",
      "categories": ["食品"],
      "confirmedBy": "user"
    },
    "产地": {
      "occurrences": [1, 5],
      "classification": "optional",
      "conflicts": [{"session": 3, "issue": "missing"}],
      "confirmedBy": "user"
    }
  },
  "interactions": {
    "生产许可证": {
      "steps": [
        {"action": "click", "selector": ".expand-btn"},
        {"action": "fill", "selector": "#license-input"}
      ]
    }
  },
  "defaults": {
    "运费模板": "包邮模板",
    "发货地": "浙江杭州"
  }
}
```

**学习管理命令**

```
$ ecom learn status      # 查看学习状态
$ ecom learn reset       # 重置学习，重新开始
$ ecom learn continue    # 继续学习（增加录制次数）
$ ecom learn fields      # 查看已学习的字段分类
$ ecom learn export      # 导出学习结果
$ ecom learn import      # 导入学习结果（复用配置）
```

---

### 交互形式

**CLI + 浏览器联动**

```
┌─────────────┐          ┌─────────────┐
│    CLI      │ ──控制─→ │   浏览器     │
│  (控制台)   │ ←─反馈── │  (淘宝页面)  │
└─────────────┘          └─────────────┘
      ↑                        ↑
      │                        │
      └──── 用户观察/介入 ──────┘
```

| 角色 | 职责 |
|------|------|
| CLI | 交互引导、显示进度、输出提示、管理配置 |
| 浏览器 | 执行页面操作、展示填充过程、暂停等待用户 |

### 交互模式

> **交互引导为主，命令行为辅**

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 交互引导 | 输入 `ecom` 进入引导流程，系统一步步提示 | 日常使用、新手 |
| 命令行 | 直接输入完整命令，如 `ecom run <url>` | 熟练用户、脚本 |

### 命令结构

**用户命令（对外暴露）**

| 命令 | 说明 |
|------|------|
| `ecom` | 进入交互引导（主入口） |
| `ecom --help` | 显示帮助 |
| `ecom config` | 配置管理 |

**快捷命令（熟练用户/脚本）**

| 命令 | 说明 |
|------|------|
| `ecom run <url>` | 一键采集+上架 |
| `ecom collect <url>` | 仅采集 |
| `ecom upload <file>` | 仅上架 |

### 主入口交互流程

**启动界面**

```
$ ecom

╭─────────────────────────────────────╮
│  淘宝商品上架工具 v1.0              │
│  学习状态: 已完成 (5/5)             │
╰─────────────────────────────────────╯

? 请选择操作:
  (1) 🚀 采集并上架商品
  (2) 📦 仅采集商品
  (3) 📤 上架已采集商品
  (4) 📚 学习管理
  (5) ❓ 问题与知识库
  (6) ⚙️  设置
  (0) 退出
> 1
```

**流程 1：采集并上架**

```
? 请输入要搬运的商品链接:
> https://item.taobao.com/item.htm?id=xxx

⏳ 正在采集商品信息...
✓ 标题: 有机燕麦片 500g
✓ 价格: 29.9
✓ 主图: 5 张
✓ SKU: 3 个规格

? 是否需要修改？
  (1) 直接上架
  (2) 修改后上架
  (3) 仅保存，稍后上架
> 1

⏳ 正在打开上架页面...
✓ 填充标题
✓ 上传主图 (5/5)
✓ 填充价格
⚠️ 遇到问题：字段 [生产许可证] 定位失败

? 请选择处理方式:
  (1) 在浏览器手动处理
  (2) 🎬 使用 codegen 录制
  (3) 跳过此字段
> 1

⏸️ 请在浏览器中完成操作，完成后按 Enter...

✓ 继续填充...
✓ 上架完成！

? 是否将解决方式沉淀到知识库？(Y/n)
```

**流程 2：学习管理**

```
? 请选择操作:
  (4) 📚 学习管理
> 4

╭─────────────────────────────────────╮
│  学习状态                           │
│  ├─ 阶段: 已完成                    │
│  ├─ 录制次数: 5/5                   │
│  └─ 最后学习: 2小时前               │
╰─────────────────────────────────────╯

? 学习管理:
  (1) 查看字段分类
  (2) 继续学习（增加录制）
  (3) 重置学习
  (4) 导出学习结果
  (5) 返回
> 1

字段分类：
┌─────────────────────────────────────┐
│ 固定字段                            │
│ ├── 商品标题                        │
│ ├── 价格                            │
│ ├── 主图                            │
│ └── SKU                             │
│                                     │
│ 动态字段                            │
│ ├── 保质期 (食品类目)               │
│ └── 生产许可证 (食品类目)           │
│                                     │
│ 可选字段                            │
│ └── 产地                            │
└─────────────────────────────────────┘
```

**流程 3：问题与知识库**

```
? 请选择操作:
  (5) ❓ 问题与知识库
> 5

? 问题与知识库:
  (1) 查看最近问题
  (2) 查看知识库统计
  (3) 管理录制方案
  (4) 管理问题分类
  (5) 导出/导入知识库
  (6) 返回
> 2

知识库统计：
├── 问题总数：42
├── 已沉淀方案：28
├── 自动解决率：66.7%
│
├── 按阶段分布：
│   ├── 采集：12 (自动 10)
│   ├── 填充：25 (自动 15)
│   └── 上传：5  (自动 3)
│
└── 信任等级：
    ├── trusted：18
    ├── testing：6
    └── new：4
```

### 状态提示

```
正常：✓ 操作成功
警告：⚠️ 需要手动处理
错误：❌ 操作失败
暂停：⏸️ 等待用户操作
重试：🔄 正在重试
录制：🎬 codegen 录制中
```

---

## 8. 数据设计

### 核心数据实体

| 实体 | 用途 | 关键字段（示意） |
|------|------|------------------|
| **商品数据包** | 存储采集的商品信息 | 源链接、标题、价格、图片、SKU |
| **默认配置** | 用户预设值 | 运费模板、发货地、素材目录 |
| **上架记录** | 追踪上架结果 | 商品、类目、状态、耗时、时间 |
| **问题记录** | 记录遇到的问题 | 阶段、类型、错误信息、解决方式 |
| **知识库** | 沉淀问题和方案 | 问题特征、解决方案、命中次数 |

### 数据关系

```
商品数据包 ──1:N──→ 上架记录 ──1:N──→ 问题记录
                                        ↓
                                    知识库（沉淀）
```

*详细字段定义在研发阶段细化*

---

## 9. 异常与兜底

### 异常场景及处理

| 阶段 | 异常场景 | 兜底策略 |
|------|----------|----------|
| **采集** | 页面加载超时 | 自动重试 3 次，失败则提示用户 |
| | 反爬拦截 | 暂停，提示用户手动验证后继续 |
| | 商品下架/不存在 | 终止并提示 |
| | 字段提取失败 | 记录缺失字段，允许用户手动补充 |
| **填充** | 必填字段无值 | 暂停，提示用户输入 |
| | 字段定位失败 | 记录问题，暂停让用户手动填充 |
| | 页面结构变化 | 记录问题，人工介入，沉淀新规则 |
| **上传** | 图片上传失败 | 重试 3 次，失败则跳过或暂停 |
| | 表单提交失败 | 记录错误，提示用户检查 |
| | 登录态失效 | 暂停，提示用户重新登录 |

### 兜底原则

| 原则 | 说明 |
|------|------|
| **不丢数据** | 采集的数据本地保存，失败可重试 |
| **可恢复** | 任何阶段失败，可从断点继续 |
| **有记录** | 所有异常记录日志，便于排查和沉淀 |
| **人工兜底** | 自动解决不了的，暂停让用户介入 |

---

## 10. 开放问题

### 待后续明确

| # | 问题 | 说明 | 何时解决 |
|---|------|------|----------|
| 1 | 登录态管理 | 如何获取和维护淘宝登录状态？ | 研发阶段 |
| 2 | 浏览器控制方式 | Puppeteer/Playwright/其他？ | 研发阶段 |
| 3 | 知识库存储 | 本地文件还是数据库？ | 研发阶段 |
| 4 | 类目扩展机制 | 从食品扩展到其他类目的流程 | 测试验证后 |
| 5 | 多店铺支持 | 后续如何支持多店铺切换？ | 后续迭代 |
| 6 | 批量上架 | 批量模式的交互和流程设计 | 后续迭代 |

### MVP 边界

| 范围 | MVP 包含 | 后续迭代 |
|------|----------|----------|
| 商品来源 | 淘宝/天猫 | 1688 |
| 目标店铺 | 单店铺 | 多店铺 |
| 类目 | 食品类目 | 其他类目 |
| 操作模式 | 单品 | 批量 |
| 素材处理 | 原图上传 | 去水印/编辑 |

---

## 更新记录

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v1 | 2026-01-29 | 初始版本 |
| v1.1 | 2026-01-30 | 补充 codegen 交互设计（6.4节），包含录制流程、信任等级、方案管理 |
| v1.2 | 2026-01-30 | 新增「学习驱动初始化」设计（7.1节），字段分类从预设规则改为学习识别 |
| v1.3 | 2026-01-30 | 新增概览章节，支持动态加载 |
| v1.4 | 2026-01-30 | 完善交互设计：交互引导为主、命令结构、主入口流程 |
